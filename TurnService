-- TurnService.server.lua
-- จัดการระบบเทิร์นและลำดับผู้เล่น
-- Version: 2.1.0 (Optimized)

local ServerStorage = game:GetService("ServerStorage")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

-- โหลดโมดูล
local TurnSystem = require(ServerStorage.Modules.TurnSystem)

-- สร้าง Service object เพื่อ return
local TurnService = {}

-- ฟังก์ชันหาบริการอื่นๆ
local function getGameManager()
	local startTime = tick()
	while not _G.GameManager and tick() - startTime < 10 do
		wait(0.1)
	end
	return _G.GameManager
end

local function getPlayerManager()
	local gameManager = getGameManager()
	return gameManager and gameManager.playerManager
end

local function getBoardSystem()
	local gameManager = getGameManager()
	return gameManager and gameManager.boardSystem
end

-- ฟังก์ชันเริ่มต้นบริการ
function TurnService:Initialize()
	-- สร้างระบบเทิร์น
	local turnSystem = TurnSystem.new()

	-- รับ Remote Events
	local remotes = ReplicatedStorage:WaitForChild("Remotes")
	local gameRemotes = remotes:WaitForChild("GameRemotes")
	local uiRemotes = remotes:WaitForChild("UIRemotes")

	-- ตั้งค่าการสื่อสารกับ Remote Events
	turnSystem:InitializeRemotes(gameRemotes)

	-- ดึง GameManager
	local gameManager = getGameManager()
	if not gameManager then
		spawn(function()
			wait(5)
			TurnService:Initialize()
		end)
		return nil
	end

	-- ตั้งค่า GameManager
	gameManager.turnSystem = turnSystem

	-- ตรวจสอบและสร้าง Remote Event ที่จำเป็น
	if not uiRemotes:FindFirstChild("UpdateTurnDetails") then
		local updateTurnDetailsEvent = Instance.new("RemoteEvent")
		updateTurnDetailsEvent.Name = "UpdateTurnDetails"
		updateTurnDetailsEvent.Parent = uiRemotes
	end

	-- ตั้งค่า Event handlers

	-- เมื่อเริ่มเทิร์น
	turnSystem.onTurnStart = function(playerID)
		-- สร้างข้อมูลสำหรับ UI
		local player = Players:GetPlayerByUserId(playerID)
		if player then
			local playerManager = getPlayerManager()
			local playerData = playerManager and playerManager:GetPlayerData(player)

			-- ส่งข้อมูลเพิ่มเติมไปยังทุกคลเอนต์
			uiRemotes:WaitForChild("UpdateTurnDetails"):FireAllClients({
				playerId = playerID,
				playerName = player.Name,
				turnNumber = gameManager.gameState.currentTurn or 1,
				playerClass = playerData and playerData.class or "Unknown",
				playerLevel = playerData and playerData.stats and playerData.stats.level or 1
			})
		end
	end

	-- เมื่อจบเทิร์น
	turnSystem.onTurnEnd = function(playerID, reason)
		-- อัปเดต game state
		if gameManager.gameState.currentTurn then
			gameManager.gameState.currentTurn = gameManager.gameState.currentTurn + 1
		else
			gameManager.gameState.currentTurn = 1
		end
	end

	-- เชื่อมต่อกับเหตุการณ์ผู้เล่นออกจากเกม
	Players.PlayerRemoving:Connect(function(player)
		turnSystem:HandlePlayerLeaving(player.UserId)
	end)

	-- เชื่อมต่อกับเหตุการณ์เริ่มเกม
	gameRemotes:WaitForChild("StartGame").OnServerEvent:Connect(function()
		-- สร้างลำดับเทิร์นจากผู้เล่นที่มีอยู่
		local playerManager = getPlayerManager()
		turnSystem:CreateTurnOrderFromActivePlayers(playerManager)

		-- เริ่มระบบเทิร์น
		turnSystem:StartTurnSystem()

		-- ตั้งค่าจำนวนเทิร์นเริ่มต้น
		gameManager.gameState.currentTurn = 1
	end)

	-- เชื่อมต่อกับเหตุการณ์จบเกม
	gameRemotes:WaitForChild("EndGame").OnServerEvent:Connect(function()
		-- รีเซ็ตระบบเทิร์น
		turnSystem:Reset()
	end)

	-- เพิ่มไปที่ global state
	_G.TurnSystem = turnSystem

	return turnSystem
end

-- เริ่มต้นบริการ
TurnService.system = TurnService:Initialize()

return TurnService
