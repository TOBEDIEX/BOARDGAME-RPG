-- EventTileHandler.client.lua
-- จัดการอีเวนต์ช่องพิเศษฝั่งไคลเอนต์ (มีอนิเมชันหมุนและสุ่มไพ่)
-- Version: 7.0.0 - Optimized

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

-- Constants
local DEBUG = true
local MONEY_COLOR = Color3.fromRGB(255, 215, 0)
local SHOP_COLOR = Color3.fromRGB(85, 170, 255)
local BATTLE_COLOR = Color3.fromRGB(255, 80, 80)
local CASINO_COLOR = Color3.fromRGB(220, 120, 255)
local ITEM_COLOR = Color3.fromRGB(100, 255, 100)
local MONEY_RANGE = {500, 2000}
local DELAY_BEFORE_UI = 0.5
local NOTIFY_DURATION = 3

-- Get local player
local player = Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")

-- State variables
local state = {
	pendingMoneyTile = false,
	moneyAmount = 0,
	lastTileId = nil,
	lastTileType = nil,
	isMakingPathChoice = false,
	isMoving = false,
	hasReachedEndTile = false,
	isProcessingEvent = false
}

-- Remote events (เริ่มต้นเป็น nil จะถูกเตรียมในฟังก์ชัน initRemotes)
local remotes, eventTileRemotes, moneyEventRemote
local uiRemotes, statChangedEvent
local boardRemotes, tileTriggerEvent, playerArrivedAtTile, movementVisualizationComplete
local showPathSelection, startPlayerMovementPath, activityComplete

-- Helper functions
local function log(msg) if DEBUG then print("[EventTileHandler] " .. msg) end end

local function tweenUI(obj, duration, properties, style, direction, onComplete)
	style = style or Enum.EasingStyle.Quad
	direction = direction or Enum.EasingDirection.Out

	local tween = TweenService:Create(
		obj, 
		TweenInfo.new(duration, style, direction), 
		properties
	)

	if onComplete then tween.Completed:Connect(onComplete) end
	tween:Play()
	return tween
end

local function playSound(parent, soundId, volume)
	local sound = Instance.new("Sound")
	sound.SoundId = soundId
	sound.Volume = volume or 0.5
	sound.Parent = parent
	sound:Play()
	return sound
end

-- Initialize all remote events
local function initRemotes()
	-- Event Tile Remotes
	remotes = ReplicatedStorage:WaitForChild("Remotes")
	eventTileRemotes = remotes:FindFirstChild("EventTileRemotes")
	if not eventTileRemotes then
		eventTileRemotes = Instance.new("Folder")
		eventTileRemotes.Name = "EventTileRemotes"
		eventTileRemotes.Parent = remotes
	end

	moneyEventRemote = eventTileRemotes:FindFirstChild("MoneyEvent")
	if not moneyEventRemote then
		moneyEventRemote = Instance.new("RemoteEvent")
		moneyEventRemote.Name = "MoneyEvent"
		moneyEventRemote.Parent = eventTileRemotes
	end

	-- Board Remotes
	uiRemotes = remotes:WaitForChild("UIRemotes")
	statChangedEvent = uiRemotes:FindFirstChild("StatChanged")

	boardRemotes = remotes:WaitForChild("BoardRemotes")
	tileTriggerEvent = boardRemotes:WaitForChild("TileTriggerEvent")
	playerArrivedAtTile = boardRemotes:WaitForChild("PlayerArrivedAtTile")
	movementVisualizationComplete = boardRemotes:FindFirstChild("MovementVisualizationComplete")
	showPathSelection = boardRemotes:FindFirstChild("ShowPathSelection")
	startPlayerMovementPath = boardRemotes:WaitForChild("StartPlayerMovementPath")
	activityComplete = boardRemotes:FindFirstChild("ActivityComplete")
end

-- สร้างแจ้งเตือน
local function createNotification(message, duration, color)
	duration = duration or NOTIFY_DURATION
	color = color or MONEY_COLOR

	local notification = Instance.new("Frame")
	notification.Name = "MoneyNotification"
	notification.Size = UDim2.new(0, 280, 0, 60)
	notification.Position = UDim2.new(0.5, 0, -0.2, 0)
	notification.AnchorPoint = Vector2.new(0.5, 0)
	notification.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
	notification.BackgroundTransparency = 0.2
	notification.BorderSizePixel = 0

	-- เพิ่ม UI Elements
	local corner = Instance.new("UICorner", notification)
	corner.CornerRadius = UDim.new(0, 8)

	local icon = Instance.new("ImageLabel", notification)
	icon.Name = "Icon"
	icon.Size = UDim2.new(0, 32, 0, 32)
	icon.Position = UDim2.new(0, 14, 0.5, 0)
	icon.AnchorPoint = Vector2.new(0, 0.5)
	icon.BackgroundTransparency = 1
	icon.Image = "rbxassetid://3354536235" -- ไอคอนเหรียญ

	local textLabel = Instance.new("TextLabel", notification)
	textLabel.Name = "Message"
	textLabel.Size = UDim2.new(1, -60, 1, 0)
	textLabel.Position = UDim2.new(0, 56, 0, 0)
	textLabel.BackgroundTransparency = 1
	textLabel.Text = message
	textLabel.Font = Enum.Font.GothamSemibold
	textLabel.TextSize = 16
	textLabel.TextColor3 = color
	textLabel.TextXAlignment = Enum.TextXAlignment.Left
	textLabel.TextWrapped = true

	notification.Parent = PlayerGui

	-- แสดงและซ่อนการแจ้งเตือน
	tweenUI(notification, 0.5, {Position = UDim2.new(0.5, 0, 0.05, 0)}, Enum.EasingStyle.Back, Enum.EasingDirection.Out)

	task.delay(duration, function()
		tweenUI(notification, 0.5, {Position = UDim2.new(0.5, 0, -0.2, 0)}, Enum.EasingStyle.Quad, Enum.EasingDirection.In, 
		function() 
			notification:Destroy() 
		end)
	end)

	return notification
end

-- ค้นหา UI MedievalMoneyRandomizer
local function findMoneyRandomizerUI()
	-- ค้นหาใน PlayerGui โดยตรง
	local moneyUI = PlayerGui:FindFirstChild("MedievalMoneyRandomizer")
	if moneyUI then return moneyUI end

	-- ค้นหาในทุก ScreenGui
	for _, gui in pairs(PlayerGui:GetChildren()) do
		if gui:IsA("ScreenGui") then
			moneyUI = gui:FindFirstChild("MedievalMoneyRandomizer")
			if moneyUI then return moneyUI end

			-- ค้นหาใน Frame ลูก
			for _, child in pairs(gui:GetDescendants()) do
				if child:IsA("Frame") and child.Name == "MedievalMoneyRandomizer" then
					return child
				end
			end
		end
	end
	return nil
end

-- เล่นอนิเมชันการ์ดหมุน
local function playCardRevealAnimation(frame, onComplete)
	if not frame then 
		if onComplete then onComplete() end
		return 
	end

	log("เล่นอนิเมชันสุ่มไพ่")

	-- บันทึกค่าเดิม
	local originalRotation = frame.Rotation or 0
	local originalSize = frame.Size
	local originalPosition = frame.Position
	local originalTransparency = frame.BackgroundTransparency or 0

	-- สร้างไพ่หลัง
	local cardBack = Instance.new("Frame")
	cardBack.Name = "CardBack"
	cardBack.Size = originalSize
	cardBack.Position = originalPosition
	cardBack.AnchorPoint = frame.AnchorPoint
	cardBack.BackgroundColor3 = Color3.fromRGB(180, 0, 0)
	cardBack.ZIndex = frame.ZIndex + 1
	cardBack.Parent = frame.Parent

	-- เพิ่มลายและขอบ
	local pattern = Instance.new("ImageLabel")
	pattern.Name = "CardPattern"
	pattern.Size = UDim2.fromScale(0.8, 0.8)
	pattern.Position = UDim2.fromScale(0.5, 0.5)
	pattern.AnchorPoint = Vector2.new(0.5, 0.5)
	pattern.BackgroundTransparency = 1
	pattern.Image = "rbxassetid://6127039592"
	pattern.ImageColor3 = Color3.fromRGB(255, 220, 220)
	pattern.ImageTransparency = 0.7
	pattern.ZIndex = cardBack.ZIndex + 1
	pattern.Parent = cardBack

	local border = Instance.new("UIStroke")
	border.Color = Color3.fromRGB(255, 215, 0)
	border.Thickness = 3
	border.Parent = cardBack

	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, 8)
	corner.Parent = cardBack

	-- ซ่อน frame หลัก
	frame.Visible = false

	-- กำหนดจุดเริ่มต้น
	cardBack.Rotation = 180
	cardBack.Size = UDim2.new(
		originalSize.X.Scale, originalSize.X.Offset * 0.8,
		originalSize.Y.Scale, originalSize.Y.Offset * 0.8
	)

	-- เล่นเสียงไพ่พลิก
	playSound(cardBack, "rbxassetid://6732897163", 0.5)

	-- อนิเมชันสุ่มไพ่
	local numShuffle = 5
	local shuffleDelay = 0.1

	for i = 1, numShuffle do
		task.delay(i * shuffleDelay, function()
			local offsetX = math.random(-10, 10)
			local offsetY = math.random(-10, 10)

			tweenUI(cardBack, shuffleDelay, {
				Position = UDim2.new(
					originalPosition.X.Scale, originalPosition.X.Offset + offsetX,
					originalPosition.Y.Scale, originalPosition.Y.Offset + offsetY
				),
				Rotation = originalRotation + math.random(-15, 15)
			})
		end)
	end

	-- พลิกไพ่หลังจากสุ่ม
	task.delay(numShuffle * shuffleDelay + 0.2, function()
		-- กลับไปตำแหน่งเดิม
		tweenUI(cardBack, 0.3, {
			Position = originalPosition,
			Rotation = 0
		}, Enum.EasingStyle.Back, Enum.EasingDirection.Out, function()
			-- เล่นเสียงพลิกการ์ด
			playSound(cardBack, "rbxassetid://5852130173", 0.7)

			-- อนิเมชันการ์ดหายไป
			tweenUI(cardBack, 0.4, {
				Size = UDim2.new(
					originalSize.X.Scale, originalSize.X.Offset * 0.1,
					originalSize.Y.Scale, originalSize.Y.Offset
				),
				Rotation = 90
			}, Enum.EasingStyle.Back, Enum.EasingDirection.In, function()
				-- ลบการ์ดหลัง
				cardBack:Destroy()

				-- แสดงการ์ดหน้า
				frame.Visible = true
				frame.Rotation = 90
				frame.Size = UDim2.new(
					originalSize.X.Scale, originalSize.X.Offset * 0.1,
					originalSize.Y.Scale, originalSize.Y.Offset
				)

				-- อนิเมชันการ์ดหน้าปรากฏ
				tweenUI(frame, 0.4, {
					Rotation = 0,
					Size = originalSize,
					BackgroundTransparency = originalTransparency
				}, Enum.EasingStyle.Back, Enum.EasingDirection.Out, function()
					-- เล่นเสียงประกาย
					playSound(frame, "rbxassetid://5852296378", 0.5)

					-- สร้างประกาย
					for i = 1, 8 do
						task.delay(i * 0.05, function()
							local sparkle = Instance.new("Frame")
							sparkle.Name = "Sparkle" .. i
							sparkle.Size = UDim2.fromOffset(5, 5)
							sparkle.Position = UDim2.fromScale(math.random(), math.random())
							sparkle.AnchorPoint = Vector2.new(0.5, 0.5)
							sparkle.BackgroundColor3 = Color3.fromRGB(255, 215, 0)
							sparkle.BackgroundTransparency = 0
							sparkle.ZIndex = frame.ZIndex + 5

							local corner = Instance.new("UICorner")
							corner.CornerRadius = UDim.new(1, 0)
							corner.Parent = sparkle

							sparkle.Parent = frame

							tweenUI(sparkle, 0.5, {
								Size = UDim2.fromOffset(20, 20),
								Position = UDim2.fromScale(0.5, 0.5),
								BackgroundTransparency = 1
							}, nil, nil, function()
								sparkle:Destroy()
								if i == 8 and onComplete then onComplete() end
								end)
								end)
								end
								end)
								end)
								end)
								end)
								end

								-- สุ่มและแสดงเงิน
local function getRandomMoneyAmount()
	return math.random(MONEY_RANGE[1], MONEY_RANGE[2])
end

-- แสดงอนิเมชันเงิน
local function showMoneyAnimationWithExistingUI(amount)
	log("💰 แสดงอนิเมชันเงิน: " .. amount)

	-- ค้นหา UI
	local moneyUI = findMoneyRandomizerUI()
	if not moneyUI then
		log("❌ ไม่พบ UI เงิน ใช้การแจ้งเตือนแทน")
		createNotification("คุณได้รับ " .. amount .. " เหรียญ!", NOTIFY_DURATION, MONEY_COLOR)
		moneyEventRemote:FireServer("updateMoney", amount)
		return
	end

	-- ค้นหา MainFrame
	local mainFrame
	if moneyUI:IsA("Frame") then
		mainFrame = moneyUI
	else
		mainFrame = moneyUI:FindFirstChild("MainFrame")
		if not mainFrame then
			for _, child in pairs(moneyUI:GetDescendants()) do
				if child:IsA("Frame") and (child.Name == "MainFrame" or child.Name:find("Main")) then
					mainFrame = child
					break
				end
			end
		end
	end

	if not mainFrame then
		log("❌ ไม่พบ MainFrame ใช้การแจ้งเตือนแทน")
		createNotification("คุณได้รับ " .. amount .. " เหรียญ!", NOTIFY_DURATION, MONEY_COLOR)
		moneyEventRemote:FireServer("updateMoney", amount)
		return
	end

	-- ค้นหา CoinAmount
	local coinAmount
	local coinDisplay = mainFrame:FindFirstChild("CoinDisplay")

	if coinDisplay then
		coinAmount = coinDisplay:FindFirstChild("CoinAmount")
	else
		for _, child in pairs(mainFrame:GetDescendants()) do
			if child:IsA("TextLabel") and (
				child.Name == "CoinAmount" or 
					child.Name:find("Amount") or 
					child.Name:find("Money") or
					child.Name:find("Coin")
				) then
				coinAmount = child
				break
			end
		end
	end

	if not coinAmount then
		log("❌ ไม่พบ CoinAmount ใช้การแจ้งเตือนแทน")
		createNotification("คุณได้รับ " .. amount .. " เหรียญ!", NOTIFY_DURATION, MONEY_COLOR)
		moneyEventRemote:FireServer("updateMoney", amount)
		return
	end

	-- ค้นหาปุ่มปิด
	local closeButton
	for _, child in pairs(mainFrame:GetDescendants()) do
		if child:IsA("TextButton") and (
			child.Name:find("Close") or 
				child.Name:find("Accept") or 
				child.Name:find("OK") or
				child.Name:find("Button") or
				child.Name:find("Confirm")
			) then
			closeButton = child
			break
		end
	end

	-- แสดง UI และเริ่มอนิเมชัน
	moneyUI.Enabled = true

	local originalTextSize = coinAmount.TextSize
	coinAmount.Text = "0"

	playCardRevealAnimation(mainFrame, function()
		-- เสียงเหรียญ
		playSound(mainFrame, "rbxassetid://131323304", 0.5)

		-- อนิเมชันเพิ่มค่าเงิน
		local countDuration = 2
		local startTime = tick()

		local function easeOutQuart(t)
			return 1 - (1 - t)^4
		end

		local countConnection
		countConnection = RunService.RenderStepped:Connect(function()
			local elapsed = tick() - startTime
			local progress = math.min(elapsed / countDuration, 1)

			local easedProgress = easeOutQuart(progress)
			local currentValue = math.floor(easedProgress * amount)

			coinAmount.Text = tostring(currentValue)

			if progress >= 1 then
				countConnection:Disconnect()

				-- เล่นเสียงเหรียญอีกครั้ง
				playSound(mainFrame, "rbxassetid://131323304", 0.7)

				-- แสดงเอฟเฟกต์เมื่อเสร็จสิ้น
				tweenUI(coinAmount, 0.3, {TextSize = originalTextSize * 1.3}, Enum.EasingStyle.Back, Enum.EasingDirection.Out)

				task.delay(0.3, function()
					tweenUI(coinAmount, 0.2, {TextSize = originalTextSize})
				end)

				-- อัพเดทเงิน
				moneyEventRemote:FireServer("updateMoney", amount)

				-- ถ้าไม่มีปุ่มปิด ให้ปิดอัตโนมัติ
				if not closeButton then
					task.delay(5, function()
						mainFrame.Visible = false
					end)
				end
			end
		end)
	end)

	-- ถ้ามีปุ่มปิด ให้ปิด UI เมื่อกดปุ่ม
	if closeButton and not closeButton:GetAttribute("Connected") then
		closeButton.MouseButton1Click:Connect(function()
			mainFrame.Visible = false
		end)
		closeButton:SetAttribute("Connected", true)
	end
end

-- ตรวจสอบถึงช่องปลายทาง
local function checkEndTile()
	-- ป้องกันการทำงานซ้ำซ้อน
	if state.isProcessingEvent then 
		log("🔄 กำลังประมวลผลอยู่แล้ว")
		return 
	end

	-- ตรวจเงื่อนไข
	if state.isMoving then
		log("🚶 ผู้เล่นกำลังเคลื่อนที่อยู่")
		return
	end

	if not state.hasReachedEndTile then
		log("🔄 ยังไม่ถึงปลายทาง")
		return
	end

	-- มีช่องเงินรอดำเนินการ
	if state.pendingMoneyTile then
		log("🏁✅ ถึงช่องปลายทางและมีช่องเงินรอ")

		state.isProcessingEvent = true
		state.pendingMoneyTile = false

		-- สุ่มเงิน
		state.moneyAmount = getRandomMoneyAmount()

		-- แจ้งเตือนและแสดง UI
		createNotification("ถึงช่องปลายทางแล้ว! ได้รับ " .. state.moneyAmount .. " เหรียญ", NOTIFY_DURATION)

		task.delay(DELAY_BEFORE_UI, function()
			showMoneyAnimationWithExistingUI(state.moneyAmount)
			state.isProcessingEvent = false
		end)
	else
		log("🏁 ถึงช่องปลายทางแล้ว แต่ไม่มีช่องเงินรอ")
	end

	state.hasReachedEndTile = false
end

-- ตั้งค่าการเชื่อมต่อเหตุการณ์
local function setupConnections()
	-- เหตุการณ์เงิน
	moneyEventRemote.OnClientEvent:Connect(function(amount)
		if amount and amount > 0 then
			createNotification("ได้รับ " .. amount .. " เหรียญ", NOTIFY_DURATION, MONEY_COLOR)
			showMoneyAnimationWithExistingUI(amount)
		end
	end)

	-- เมื่อเริ่มเคลื่อนที่
	startPlayerMovementPath.OnClientEvent:Connect(function(playerId, movementData)
		if playerId ~= player.UserId then return end

		log("🚶 เริ่มเคลื่อนที่ตามเส้นทาง")
		state.isMoving = true
		state.hasReachedEndTile = false
	end)

	-- เมื่อถึงช่องปลายทาง
	playerArrivedAtTile.OnClientEvent:Connect(function(playerId, finalTileId)
		if playerId ~= player.UserId then return end

		log("🏁 ถึงช่องปลายทาง: " .. finalTileId)
		state.lastTileId = finalTileId
		state.isMakingPathChoice = false
	end)

	-- ตอนเลือกเส้นทาง
	if showPathSelection then
		showPathSelection.OnClientEvent:Connect(function()
			log("🧭 กำลังเลือกเส้นทาง")
			state.isMakingPathChoice = true
		end)
	end

	-- เมื่อการเคลื่อนที่เสร็จสมบูรณ์
	if movementVisualizationComplete then
		movementVisualizationComplete.OnClientEvent:Connect(function(finalTileId)
			log("✅ การเคลื่อนที่เสร็จสมบูรณ์: " .. finalTileId)
			state.lastTileId = finalTileId
			state.isMoving = false
			state.hasReachedEndTile = true
			state.isMakingPathChoice = false

			task.delay(DELAY_BEFORE_UI, checkEndTile)
		end)
	end

	-- เมื่อกิจกรรมเสร็จสิ้น
	if activityComplete then
		activityComplete.OnClientEvent:Connect(function(activityType)
			if activityType == "movement" or activityType == "turn" then
				state.isMoving = false
				state.hasReachedEndTile = true
				checkEndTile()
			end
		end)
	end

	-- เมื่อตกช่อง
	tileTriggerEvent.OnClientEvent:Connect(function(playerId, tileId, tileType)
		if playerId ~= player.UserId then return end

		log("ตกช่อง: " .. tileId .. " ประเภท " .. tileType)
		state.lastTileId = tileId
		state.lastTileType = tileType

		if state.isMakingPathChoice then
			log("⏩ ข้ามเนื่องจากกำลังเลือกเส้นทาง")
			return
		end

		-- แสดงการแจ้งเตือนตามประเภทช่อง
		if tileType == "money" then
			createNotification("คุณตกช่องเงิน! เงินจะถูกสุ่มเมื่อถึงช่องปลายทาง", 2, MONEY_COLOR)
			state.pendingMoneyTile = true
		elseif tileType == "shop" then
			createNotification("คุณตกช่องร้านค้า", 2, SHOP_COLOR)
		elseif tileType == "battle" then
			createNotification("คุณตกช่องต่อสู้! เตรียมตัวให้พร้อม", 2, BATTLE_COLOR)
		elseif tileType == "casino" then
			createNotification("คุณตกช่องคาสิโน! อยากลองเสี่ยงโชคไหม?", 2, CASINO_COLOR)
		elseif tileType == "item" then
			createNotification("คุณตกช่องไอเทม! กำลังสุ่มไอเทม...", 2, ITEM_COLOR)
		end
	end)

	-- ตรวจจับการเลือกเส้นทาง
	task.spawn(function()
		local PlayerGui = player:WaitForChild("PlayerGui")
		local PopupUI = PlayerGui:WaitForChild("PopupUI", 10)
		if PopupUI then
			local DiceRollUI = PopupUI:WaitForChild("DiceRollUI", 10)
			if DiceRollUI then
				local PathSelectionContainer = DiceRollUI:WaitForChild("PathSelectionContainer", 10)
				if PathSelectionContainer then
					PathSelectionContainer:GetPropertyChangedSignal("Visible"):Connect(function()
						state.isMakingPathChoice = PathSelectionContainer.Visible
						log("📍 การเลือกเส้นทาง: " .. (state.isMakingPathChoice and "เปิด" or "ปิด"))
					end)
				end
			end
		end
	end)

	-- ตรวจจับการเคลื่อนที่จริงของตัวละคร
	task.spawn(function()
		while true do
			task.wait(0.5) -- ตรวจสอบทุก 0.5 วินาที

			local character = player.Character
			if character and character:FindFirstChild("HumanoidRootPart") and character:FindFirstChild("Humanoid") then
				local humanoid = character:FindFirstChild("Humanoid")

				-- เช็คสถานะการเคลื่อนที่
				if humanoid.MoveDirection.Magnitude > 0 then
					if not state.isMoving then
						log("🚶 ตรวจพบการเคลื่อนที่")
						state.isMoving = true
						state.hasReachedEndTile = false
					end
				else
					if state.isMoving then
						log("🛑 ตรวจพบการหยุดเคลื่อนที่")
						state.isMoving = false

						task.delay(DELAY_BEFORE_UI, function()
							if state.pendingMoneyTile and not state.isMoving then
								log("🔄 ตัวละครหยุดและมีช่องเงินรอ")
								state.hasReachedEndTile = true
								checkEndTile()
							end
						end)
					end
				end
			end
		end
	end)
end

-- ตั้งค่าฟังก์ชันทดสอบ
local function setupTestFunctions()
	-- ทดสอบ UI เงิน
	_G.TestMoneyUI = function(amount)
		amount = amount or getRandomMoneyAmount()
		log("ทดสอบ UI เงิน: " .. amount)
		showMoneyAnimationWithExistingUI(amount)
		return "กำลังทดสอบ UI สุ่มเงิน: " .. amount .. " เหรียญ"
	end

	-- ทดสอบอนิเมชันการ์ด
	_G.TestCardAnimation = function()
		local moneyUI = findMoneyRandomizerUI()
		if moneyUI then
			local mainFrame = moneyUI:IsA("Frame") and moneyUI or moneyUI:FindFirstChild("MainFrame")
			if mainFrame then
				moneyUI.Enabled = true
				mainFrame.Visible = true
				playCardRevealAnimation(mainFrame)
				return "กำลังทดสอบอนิเมชันการ์ด"
			end
		end
		return "ไม่พบ UI ที่จะทดสอบ"
	end

	-- ทดสอบลำดับการตกช่องเงิน
	_G.TestMoneyTileSequence = function()
		log("ทดสอบลำดับการตกช่องเงินและถึงช่องปลายทาง")

		-- รีเซ็ตสถานะ
		state.pendingMoneyTile = false
		state.isMoving = false
		state.hasReachedEndTile = false
		state.isProcessingEvent = false

		-- จำลองตกช่องเงิน
		state.pendingMoneyTile = true
		createNotification("คุณตกช่องเงิน! เงินจะถูกสุ่มเมื่อถึงช่องปลายทาง", 2, MONEY_COLOR)

		-- จำลองเคลื่อนที่
		log("จำลองการเริ่มเคลื่อนที่...")
		state.isMoving = true

		-- รอแล้วจำลองการหยุด
		task.delay(2, function()
			log("จำลองการหยุดเคลื่อนที่และถึงช่องปลายทาง")
			state.isMoving = false
			state.hasReachedEndTile = true
			checkEndTile()
		end)

		return "กำลังทดสอบลำดับเหตุการณ์ตั้งแต่ตกช่องเงินจนถึงช่องปลายทาง"
	end
end

-- เริ่มต้นระบบ
local function initialize()
	log("เริ่มต้นระบบ EventTileHandler...")

	initRemotes()
	setupConnections()
	setupTestFunctions()

	-- ตรวจสอบ UI ที่มีอยู่
	task.spawn(function()
		task.wait(2)
		local ui = findMoneyRandomizerUI()
		log(ui and "✅ พบ UI MedievalMoneyRandomizer" or "❌ ไม่พบ UI MedievalMoneyRandomizer")
	end)

	log("ระบบช่องพิเศษพร้อมใช้งานแล้ว")
	print("================ ระบบช่องพิเศษ (Event Tile) พร้อมใช้งานแล้ว ================")
	print("ทดสอบได้ด้วย: _G.TestMoneyUI(), _G.TestCardAnimation(), _G.TestMoneyTileSequence()")
end

-- เริ่มต้นระบบ
initialize()
