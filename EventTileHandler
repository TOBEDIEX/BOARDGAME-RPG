-- EventTileHandler.client.lua
-- จัดการอีเวนต์ช่องพิเศษฝั่งไคลเอนต์ (มีอนิเมชันหมุนและสุ่มไพ่)
-- Version: 6.0.0 - Optimized

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

-- Constants
local DEBUG_MODE = true
local NOTIFICATION_DURATION = 3
local MONEY_COLOR = Color3.fromRGB(255, 215, 0)
local SHOP_COLOR = Color3.fromRGB(85, 170, 255)
local BATTLE_COLOR = Color3.fromRGB(255, 80, 80)
local CASINO_COLOR = Color3.fromRGB(220, 120, 255)
local ITEM_COLOR = Color3.fromRGB(100, 255, 100)
local MIN_MONEY_AMOUNT = 500
local MAX_MONEY_AMOUNT = 2000
local DELAY_BEFORE_UI = 0.5
local MOVEMENT_CHECK_INTERVAL = 0.5

-- Get local player
local player = Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")

-- State variables
local pendingMoneyTile = false
local moneyAmount = 0
local lastTileId = nil
local lastTileType = nil
local isMakingPathChoice = false
local isMoving = false
local hasReachedEndTile = false
local isProcessingEvent = false

-- Remote events
local remotes = ReplicatedStorage:WaitForChild("Remotes")
local eventTileRemotes, moneyEventRemote
local uiRemotes, statChangedEvent
local boardRemotes, tileTriggerEvent, playerArrivedAtTile, movementVisualizationComplete
local showPathSelection, startPlayerMovementPath, activityComplete

-- Forward declaration of functions
local debugLog, createNotification, findMoneyRandomizerUI, showMoneyAnimationWithExistingUI
local playCardRevealAnimation, getRandomMoneyAmount, checkEndTile, initRemotes

-- Helper function for debug logging
function debugLog(message)
	if DEBUG_MODE then
		print("[EventTileHandler] " .. message)
	end
end

-- Initialize all remote events
function initRemotes()
	eventTileRemotes = remotes:FindFirstChild("EventTileRemotes")
	if not eventTileRemotes then
		eventTileRemotes = Instance.new("Folder")
		eventTileRemotes.Name = "EventTileRemotes"
		eventTileRemotes.Parent = remotes
		debugLog("สร้างโฟลเดอร์ EventTileRemotes")
	end

	moneyEventRemote = eventTileRemotes:FindFirstChild("MoneyEvent")
	if not moneyEventRemote then
		moneyEventRemote = Instance.new("RemoteEvent")
		moneyEventRemote.Name = "MoneyEvent"
		moneyEventRemote.Parent = eventTileRemotes
		debugLog("สร้าง MoneyEvent RemoteEvent")
	end

	uiRemotes = remotes:WaitForChild("UIRemotes")
	statChangedEvent = uiRemotes:FindFirstChild("StatChanged")

	boardRemotes = remotes:WaitForChild("BoardRemotes")
	tileTriggerEvent = boardRemotes:WaitForChild("TileTriggerEvent")
	playerArrivedAtTile = boardRemotes:WaitForChild("PlayerArrivedAtTile")
	movementVisualizationComplete = boardRemotes:FindFirstChild("MovementVisualizationComplete")
	showPathSelection = boardRemotes:FindFirstChild("ShowPathSelection")
	startPlayerMovementPath = boardRemotes:WaitForChild("StartPlayerMovementPath")
	activityComplete = boardRemotes:FindFirstChild("ActivityComplete")
end

-- สร้างแอนิเมชันแจ้งเตือนปกติ
function createNotification(message, duration, color)
	duration = duration or NOTIFICATION_DURATION
	color = color or MONEY_COLOR

	-- สร้าง notification บนหน้าจอ
	local notification = Instance.new("Frame")
	notification.Name = "MoneyNotification"
	notification.Size = UDim2.new(0, 280, 0, 60)
	notification.Position = UDim2.new(0.5, 0, 0.1, 0)
	notification.AnchorPoint = Vector2.new(0.5, 0)
	notification.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
	notification.BackgroundTransparency = 0.2
	notification.BorderSizePixel = 0

	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, 8)
	corner.Parent = notification

	local icon = Instance.new("ImageLabel")
	icon.Name = "Icon"
	icon.Size = UDim2.new(0, 32, 0, 32)
	icon.Position = UDim2.new(0, 14, 0.5, 0)
	icon.AnchorPoint = Vector2.new(0, 0.5)
	icon.BackgroundTransparency = 1
	icon.Image = "rbxassetid://3354536235" -- ไอคอนเหรียญ
	icon.Parent = notification

	local textLabel = Instance.new("TextLabel")
	textLabel.Name = "Message"
	textLabel.Size = UDim2.new(1, -60, 1, 0)
	textLabel.Position = UDim2.new(0, 56, 0, 0)
	textLabel.BackgroundTransparency = 1
	textLabel.Text = message
	textLabel.Font = Enum.Font.GothamSemibold
	textLabel.TextSize = 16
	textLabel.TextColor3 = color
	textLabel.TextXAlignment = Enum.TextXAlignment.Left
	textLabel.TextWrapped = true
	textLabel.Parent = notification

	notification.Parent = PlayerGui

	-- แสดงการแจ้งเตือนด้วย tween
	notification.Position = UDim2.new(0.5, 0, -0.2, 0)
	TweenService:Create(
		notification,
		TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out),
		{Position = UDim2.new(0.5, 0, 0.05, 0)}
	):Play()

	-- ลบการแจ้งเตือนหลังจากระยะเวลาที่กำหนด
	task.delay(duration, function()
		TweenService:Create(
			notification,
			TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.In),
			{Position = UDim2.new(0.5, 0, -0.2, 0)}
		):Play()

		task.delay(0.5, function()
			notification:Destroy()
		end)
	end)

	return notification
end

-- ฟังก์ชันสร้างเอฟเฟกต์การสุ่มไพ่และหมุนการ์ด
function playCardRevealAnimation(frame, onComplete)
	if not frame then 
		if onComplete then onComplete() end
		return 
	end

	debugLog("เล่นอนิเมชันสุ่มไพ่")

	-- บันทึกค่าเดิม
	local originalRotation = frame.Rotation or 0
	local originalSize = frame.Size
	local originalPosition = frame.Position
	local originalTransparency = frame.BackgroundTransparency or 0

	-- สร้างเอฟเฟกต์ไพ่
	local cardBack = Instance.new("Frame")
	cardBack.Name = "CardBack"
	cardBack.Size = originalSize
	cardBack.Position = originalPosition
	cardBack.AnchorPoint = frame.AnchorPoint
	cardBack.BackgroundColor3 = Color3.fromRGB(180, 0, 0) -- สีแดงเข้ม
	cardBack.ZIndex = frame.ZIndex + 1
	cardBack.Parent = frame.Parent

	-- เพิ่มลายหลังไพ่
	local pattern = Instance.new("ImageLabel")
	pattern.Name = "CardPattern"
	pattern.Size = UDim2.fromScale(0.8, 0.8)
	pattern.Position = UDim2.fromScale(0.5, 0.5)
	pattern.AnchorPoint = Vector2.new(0.5, 0.5)
	pattern.BackgroundTransparency = 1
	pattern.Image = "rbxassetid://6127039592" -- รูปลายไพ่
	pattern.ImageColor3 = Color3.fromRGB(255, 220, 220)
	pattern.ImageTransparency = 0.7
	pattern.ZIndex = cardBack.ZIndex + 1
	pattern.Parent = cardBack

	-- เพิ่มขอบไพ่
	local border = Instance.new("UIStroke")
	border.Color = Color3.fromRGB(255, 215, 0)
	border.Thickness = 3
	border.Parent = cardBack

	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, 8)
	corner.Parent = cardBack

	-- ซ่อน frame หลัก
	frame.Visible = false

	-- กำหนดจุดเริ่มต้นของอนิเมชัน
	cardBack.Rotation = 180
	cardBack.Size = UDim2.new(
		originalSize.X.Scale, originalSize.X.Offset * 0.8,
		originalSize.Y.Scale, originalSize.Y.Offset * 0.8
	)

	-- เพิ่มเสียงไพ่พลิก
	local cardSound = Instance.new("Sound")
	cardSound.SoundId = "rbxassetid://6732897163" -- เสียงพลิกไพ่
	cardSound.Volume = 0.5
	cardSound.Parent = cardBack

	-- เล่นเสียง
	cardSound:Play()

	-- อนิเมชันการ์ดสุ่ม
	local numShuffle = 5 -- จำนวนครั้งที่สุ่ม
	local shuffleDelay = 0.1 -- ความเร็วในการสุ่ม

	-- สุ่มการ์ดหลายๆ ตัว
	for i = 1, numShuffle do
		task.delay(i * shuffleDelay, function()
			-- เปลี่ยนตำแหน่งเล็กน้อยในแต่ละครั้ง
			local offsetX = math.random(-10, 10)
			local offsetY = math.random(-10, 10)

			-- สร้าง tween การเคลื่อนที่
			local moveTween = TweenService:Create(
				cardBack,
				TweenInfo.new(shuffleDelay, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
				{
					Position = UDim2.new(
						originalPosition.X.Scale, originalPosition.X.Offset + offsetX,
						originalPosition.Y.Scale, originalPosition.Y.Offset + offsetY
					),
					Rotation = originalRotation + math.random(-15, 15)
				}
			)

			moveTween:Play()
		end)
	end

	-- หลังจากสุ่มเสร็จ ให้เล่นอนิเมชันพลิกการ์ด
	task.delay(numShuffle * shuffleDelay + 0.2, function()
		-- กลับไปตำแหน่งเดิม
		local resetTween = TweenService:Create(
			cardBack,
			TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out),
			{
				Position = originalPosition,
				Rotation = 0
			}
		)

		resetTween:Play()

		-- รอให้การ์ดกลับตำแหน่งก่อนพลิก
		resetTween.Completed:Connect(function()
			-- เล่นเสียงพลิกการ์ด
			local flipSound = Instance.new("Sound")
			flipSound.SoundId = "rbxassetid://5852130173"
			flipSound.Volume = 0.7
			flipSound.Parent = cardBack
			flipSound:Play()

			-- อนิเมชันการ์ดหายไป
			local flipTween = TweenService:Create(
				cardBack,
				TweenInfo.new(0.4, Enum.EasingStyle.Back, Enum.EasingDirection.In),
				{
					Size = UDim2.new(
						originalSize.X.Scale, originalSize.X.Offset * 0.1,
						originalSize.Y.Scale, originalSize.Y.Offset
					),
					Rotation = 90
				}
			)

			flipTween:Play()

			-- เมื่อการ์ดหลังหายไป ให้แสดงการ์ดหน้า
			flipTween.Completed:Connect(function()
				-- ลบการ์ดหลัง
				cardBack:Destroy()

				-- แสดงการ์ดหน้า (frame หลัก)
				frame.Visible = true
				frame.Rotation = 90
				frame.Size = UDim2.new(
					originalSize.X.Scale, originalSize.X.Offset * 0.1,
					originalSize.Y.Scale, originalSize.Y.Offset
				)

				-- อนิเมชันการ์ดหน้าปรากฏ
				local revealTween = TweenService:Create(
					frame,
					TweenInfo.new(0.4, Enum.EasingStyle.Back, Enum.EasingDirection.Out),
					{
						Rotation = 0,
						Size = originalSize,
						BackgroundTransparency = originalTransparency
					}
				)

				revealTween:Play()

				-- เพิ่มเอฟเฟกต์ประกาย
				revealTween.Completed:Connect(function()
					-- เล่นเสียงประกาย
					local sparkleSound = Instance.new("Sound")
					sparkleSound.SoundId = "rbxassetid://5852296378"
					sparkleSound.Volume = 0.5
					sparkleSound.Parent = frame
					sparkleSound:Play()

					-- สร้างประกาย
					for i = 1, 8 do
						task.delay(i * 0.05, function()
							local sparkle = Instance.new("Frame")
							sparkle.Name = "Sparkle" .. i
							sparkle.Size = UDim2.fromOffset(5, 5)
							sparkle.Position = UDim2.fromScale(math.random(), math.random())
							sparkle.AnchorPoint = Vector2.new(0.5, 0.5)
							sparkle.BackgroundColor3 = Color3.fromRGB(255, 215, 0)
							sparkle.BackgroundTransparency = 0
							sparkle.ZIndex = frame.ZIndex + 5

							-- เพิ่ม UICorner ให้เป็นวงกลม
							local corner = Instance.new("UICorner")
							corner.CornerRadius = UDim.new(1, 0)
							corner.Parent = sparkle

							sparkle.Parent = frame

							-- อนิเมชันประกาย
							local sparkTween = TweenService:Create(
								sparkle,
								TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
								{
									Size = UDim2.fromOffset(20, 20),
									Position = UDim2.fromScale(0.5, 0.5),
									BackgroundTransparency = 1
								}
							)

							sparkTween:Play()

							sparkTween.Completed:Connect(function()
								sparkle:Destroy()

								-- เรียกฟังก์ชันต่อเมื่อเสร็จสมบูรณ์
								if i == 8 and onComplete then
									onComplete()
								end
							end)
						end)
					end
				end)
			end)
		end)
	end)
end

-- ค้นหา UI MedievalMoneyRandomizer ที่มีอยู่แล้ว
function findMoneyRandomizerUI()
	debugLog("กำลังค้นหา UI MedievalMoneyRandomizer...")

	-- ค้นหาใน PlayerGui โดยตรง
	local moneyUI = PlayerGui:FindFirstChild("MedievalMoneyRandomizer")
	if moneyUI then
		debugLog("✅ พบ MedievalMoneyRandomizer ใน PlayerGui")
		return moneyUI
	end

	-- ค้นหาในทุก ScreenGui ที่เป็นลูกของ PlayerGui
	for _, gui in pairs(PlayerGui:GetChildren()) do
		if gui:IsA("ScreenGui") then
			moneyUI = gui:FindFirstChild("MedievalMoneyRandomizer")
			if moneyUI then
				debugLog("✅ พบ MedievalMoneyRandomizer ใน " .. gui.Name)
				return moneyUI
			end

			-- ค้นหาใน Frame ที่อาจมีชื่อเดียวกัน
			for _, child in pairs(gui:GetDescendants()) do
				if child:IsA("Frame") and child.Name == "MedievalMoneyRandomizer" then
					debugLog("✅ พบ MedievalMoneyRandomizer Frame ใน " .. gui.Name)
					return child
				end
			end
		end
	end

	debugLog("❌ ไม่พบ UI MedievalMoneyRandomizer")
	return nil
end

-- สุ่มจำนวนเงิน
function getRandomMoneyAmount()
	return math.random(MIN_MONEY_AMOUNT, MAX_MONEY_AMOUNT)
end

-- แสดงอนิเมชันการได้รับเงินด้วย UI ที่มีอยู่แล้ว
function showMoneyAnimationWithExistingUI(amount)
	debugLog("💰 กำลังแสดงอนิเมชันเงินจากที่มีอยู่แล้ว จำนวน: " .. amount)

	-- ค้นหา UI ที่มีอยู่แล้ว
	local moneyUI = findMoneyRandomizerUI()

	if not moneyUI then
		debugLog("❌ ไม่พบ UI เงินที่มีอยู่แล้ว จะใช้การแจ้งเตือนแทน")
		createNotification("คุณได้รับ " .. amount .. " เหรียญ!", 3, MONEY_COLOR)

		-- ส่งคำขออัพเดทเงินไปยังเซิร์ฟเวอร์โดยตรง
		moneyEventRemote:FireServer("updateMoney", amount)
		return
	end

	-- ตรวจสอบว่ามี MainFrame
	local mainFrame
	if moneyUI:IsA("Frame") then
		mainFrame = moneyUI
		debugLog("ใช้ Frame โดยตรง: " .. moneyUI.Name)
	else
		mainFrame = moneyUI:FindFirstChild("MainFrame")
		if not mainFrame then
			for _, child in pairs(moneyUI:GetDescendants()) do
				if child:IsA("Frame") and (child.Name == "MainFrame" or child.Name:find("Main")) then
					mainFrame = child
					debugLog("พบ MainFrame: " .. child.Name)
					break
				end
			end
		end
	end

	if not mainFrame then
		debugLog("❌ ไม่พบ MainFrame ใน UI จะใช้การแจ้งเตือนแทน")
		createNotification("คุณได้รับ " .. amount .. " เหรียญ!", 3, MONEY_COLOR)

		-- ส่งคำขออัพเดทเงินไปยังเซิร์ฟเวอร์โดยตรง
		moneyEventRemote:FireServer("updateMoney", amount)
		return
	end

	-- ค้นหา CoinDisplay และ CoinAmount
	local coinDisplay = mainFrame:FindFirstChild("CoinDisplay")
	local coinAmount

	if coinDisplay then
		coinAmount = coinDisplay:FindFirstChild("CoinAmount")
		debugLog("พบ CoinDisplay และ CoinAmount")
	else
		-- ค้นหา TextLabel ที่อาจเป็น CoinAmount โดยตรง
		for _, child in pairs(mainFrame:GetDescendants()) do
			if child:IsA("TextLabel") and (
				child.Name == "CoinAmount" or 
					child.Name:find("Amount") or 
					child.Name:find("Money") or
					child.Name:find("Coin")
				) then
				coinAmount = child
				debugLog("พบ CoinAmount: " .. child.Name)
				break
			end
		end
	end

	if not coinAmount then
		debugLog("❌ ไม่พบ CoinAmount ใน UI จะใช้การแจ้งเตือนแทน")
		createNotification("คุณได้รับ " .. amount .. " เหรียญ!", 3, MONEY_COLOR)

		-- ส่งคำขออัพเดทเงินไปยังเซิร์ฟเวอร์โดยตรง
		moneyEventRemote:FireServer("updateMoney", amount)
		return
	end

	-- ค้นหาปุ่มปิด
	local closeButton
	for _, child in pairs(mainFrame:GetDescendants()) do
		if child:IsA("TextButton") and (
			child.Name:find("Close") or 
				child.Name:find("Accept") or 
				child.Name:find("OK") or
				child.Name:find("Button") or
				child.Name:find("Confirm")
			) then
			closeButton = child
			debugLog("พบปุ่มปิด: " .. child.Name)
			break
		end
	end

	-- เตรียม UI
	moneyUI.Enabled = true

	-- บันทึกค่าเดิม
	local originalTextSize = coinAmount.TextSize
	local originalText = coinAmount.Text

	-- ตั้งค่าเริ่มต้น
	coinAmount.Text = "0"

	-- เล่นเอฟเฟกต์การ์ดหมุน
	playCardRevealAnimation(mainFrame, function()
		-- เสียงเหรียญ
		local coinSound = Instance.new("Sound")
		coinSound.SoundId = "rbxassetid://131323304" -- เสียงเหรียญ
		coinSound.Volume = 0.5
		coinSound.Parent = mainFrame
		coinSound:Play()

		-- อนิเมชันเพิ่มค่าเงินทีละนิด
		local countDuration = 2 -- เวลาที่ใช้นับ (วินาที)
		local startTime = tick()
		local startValue = 0
		local targetValue = amount

		-- ฟังก์ชัน easing สำหรับการนับเงิน
		local function easeOutQuart(t)
			return 1 - (1 - t)^4
		end

		-- อัปเดตค่าเงินแบบเรียลไทม์
		local countConnection
		countConnection = RunService.RenderStepped:Connect(function()
			local elapsed = tick() - startTime
			local progress = math.min(elapsed / countDuration, 1)

			-- คำนวณค่าปัจจุบันตาม easing function
			local easedProgress = easeOutQuart(progress)
			local currentValue = math.floor(startValue + easedProgress * (targetValue - startValue))

			-- อัปเดตข้อความ
			coinAmount.Text = tostring(currentValue)

			-- หยุดเมื่อเสร็จสิ้น
			if progress >= 1 then
				countConnection:Disconnect()

				-- เล่นเสียงเหรียญอีกครั้งเมื่อจบ
				local finalCoinSound = Instance.new("Sound")
				finalCoinSound.SoundId = "rbxassetid://131323304" -- เสียงเหรียญสุดท้าย
				finalCoinSound.Volume = 0.7
				finalCoinSound.Parent = mainFrame
				finalCoinSound:Play()

				-- แสดงเอฟเฟกต์เมื่อเสร็จสิ้น
				TweenService:Create(
					coinAmount, 
					TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out), 
					{TextSize = originalTextSize * 1.3}
				):Play()

				task.delay(0.3, function()
					TweenService:Create(
						coinAmount, 
						TweenInfo.new(0.2, Enum.EasingStyle.Quad), 
						{TextSize = originalTextSize}
					):Play()
				end)

				-- อัพเดทเงินหลังจากแสดงอนิเมชันเสร็จ
				-- ใช้เงินจำนวนเดียวกับที่แสดงบนหน้าจอ
				moneyEventRemote:FireServer("updateMoney", amount)

				-- ถ้าไม่มีปุ่มปิด ให้ปิดอัตโนมัติหลังจาก 5 วินาที
				if not closeButton then
					task.delay(5, function()
						mainFrame.Visible = false
					end)
				end
			end
		end)
	end)

	-- ถ้ามีปุ่มปิด ให้ปิด UI เมื่อกดปุ่ม
	if closeButton then
		-- ตรวจสอบว่ามีการเชื่อมต่อกับปุ่มแล้วหรือไม่
		if not closeButton:GetAttribute("Connected") then
			closeButton.MouseButton1Click:Connect(function()
				mainFrame.Visible = false
			end)
			closeButton:SetAttribute("Connected", true)
		end
	end
end

-- ฟังก์ชันสำหรับตรวจสอบว่าผู้เล่นถึงช่องปลายทางหรือไม่
function checkEndTile()
	-- ป้องกันการทำงานซ้ำซ้อน
	if isProcessingEvent then 
		debugLog("🔄 กำลังประมวลผลอยู่แล้ว ข้ามการทำงานซ้ำซ้อน")
		return 
	end

	-- ตรวจสอบว่ากำลังเคลื่อนที่อยู่หรือไม่
	if isMoving then
		debugLog("🚶 ผู้เล่นกำลังเคลื่อนที่อยู่ ยังไม่ถึงปลายทาง")
		return
	end

	-- ตรวจสอบว่าถึงช่องปลายทางจริงๆ แล้วหรือไม่
	if not hasReachedEndTile then
		debugLog("🔄 ยังไม่เข้าเงื่อนไขถึงปลายทาง รอให้ hasReachedEndTile เป็น true")
		return
	end

	-- ตรวจสอบว่ามีช่องเงินที่รอดำเนินการหรือไม่
	if pendingMoneyTile then
		debugLog("🏁✅ ผู้เล่นถึงช่องปลายทางแล้ว และมีช่องเงินที่รอดำเนินการ")

		-- ตั้งค่าการประมวลผลเพื่อป้องกันการทำงานซ้ำซ้อน
		isProcessingEvent = true
		pendingMoneyTile = false

		-- สุ่มจำนวนเงิน
		moneyAmount = getRandomMoneyAmount()

		-- แสดงการแจ้งเตือนและ UI เงิน
		createNotification("ถึงช่องปลายทางแล้ว! ได้รับ " .. moneyAmount .. " เหรียญ", 3)

		-- รอสักครู่ก่อนแสดง UI (ให้แน่ใจว่าตัวละครหยุดเคลื่อนที่แล้ว)
		task.delay(DELAY_BEFORE_UI, function()
			showMoneyAnimationWithExistingUI(moneyAmount)
			isProcessingEvent = false -- คืนค่าเมื่อเสร็จสิ้น
		end)
	else
		debugLog("🏁 ผู้เล่นถึงช่องปลายทางแล้ว แต่ไม่มีช่องเงินที่รอดำเนินการ")
	end

	-- รีเซ็ตสถานะ
	hasReachedEndTile = false
end

-- Function to setup event connections
local function setupConnections()
	-- เชื่อมต่อกับเหตุการณ์เงิน (แต่จะไม่ใช้โดยตรง เก็บไว้สำหรับความเข้ากันได้กับระบบเดิม)
	moneyEventRemote.OnClientEvent:Connect(function(amount, isEndTile)
		debugLog("🔔 ได้รับเหตุการณ์เงินจากเซิร์ฟเวอร์: " .. tostring(amount))

		-- ถ้าได้รับการตอบกลับจากเซิร์ฟเวอร์ ให้แสดง UI เงิน
		if amount and amount > 0 then
			createNotification("ถึงช่องปลายทางแล้ว! ได้รับ " .. amount .. " เหรียญ", 3)
			showMoneyAnimationWithExistingUI(amount)
		end
	end)

	-- เชื่อมต่อกับ StartPlayerMovementPath (จับเมื่อเริ่มเคลื่อนที่)
	startPlayerMovementPath.OnClientEvent:Connect(function(playerId, movementData)
		-- ตรวจสอบว่าเป็นการเคลื่อนที่ของผู้เล่นปัจจุบันหรือไม่
		if playerId ~= player.UserId then return end

		debugLog("🚶 ผู้เล่นเริ่มเคลื่อนที่ตามเส้นทาง")
		isMoving = true
		hasReachedEndTile = false -- รีเซ็ตสถานะเมื่อเริ่มเคลื่อนที่ใหม่
	end)

	-- เชื่อมต่อกับ PlayerArrivedAtTile (ช่องปลายทาง)
	playerArrivedAtTile.OnClientEvent:Connect(function(playerId, finalTileId)
		-- ตรวจสอบว่าเป็นผู้เล่นปัจจุบันหรือไม่
		if playerId ~= player.UserId then return end

		debugLog("🏁 เซิร์ฟเวอร์แจ้งว่าผู้เล่นถึงช่องปลายทาง: " .. finalTileId)
		lastTileId = finalTileId

		-- ตั้ง isMakingPathChoice เป็น false เพราะถึงช่องปลายทางแล้ว
		isMakingPathChoice = false

		-- แต่ยังไม่ตั้ง hasReachedEndTile เป็น true ทันที เพราะต้องรอให้อนิเมชันเคลื่อนที่เสร็จก่อน
		-- hasReachedEndTile จะถูกตั้งค่าเมื่อได้รับเหตุการณ์ MovementVisualizationComplete
	end)

	-- เชื่อมต่อกับ ShowPathSelection เพื่อรู้ว่ากำลังเลือกเส้นทางหรือไม่
	if showPathSelection then
		showPathSelection.OnClientEvent:Connect(function()
			debugLog("🧭 ผู้เล่นกำลังเลือกเส้นทาง (ยังไม่ถึงช่องปลายทาง)")
			isMakingPathChoice = true
		end)
	end

	-- เชื่อมต่อกับ MovementVisualizationComplete (การเคลื่อนที่เสร็จสมบูรณ์)
	if movementVisualizationComplete then
		-- เหตุการณ์นี้เกิดขึ้นเมื่อการเคลื่อนที่ในฝั่ง Client เสร็จสิ้น
		movementVisualizationComplete.OnClientEvent:Connect(function(finalTileId)
			debugLog("✅ ได้รับเหตุการณ์ MovementVisualizationComplete: " .. finalTileId)
			lastTileId = finalTileId

			-- ตั้งสถานะว่าหยุดเคลื่อนที่แล้ว
			isMoving = false

			-- ตั้งสถานะว่าถึงช่องปลายทางแล้ว
			hasReachedEndTile = true

			-- ตั้ง isMakingPathChoice เป็น false เพราะถึงช่องปลายทางแล้ว
			isMakingPathChoice = false

			-- ตรวจสอบว่ามีช่องเงินที่รอดำเนินการหรือไม่
			-- รอสักครู่ให้ตัวละครหยุดสนิทก่อน
			task.delay(DELAY_BEFORE_UI, function()
				checkEndTile()
			end)
		end)
	end

	-- เชื่อมต่อกับ ActivityComplete (เมื่อกิจกรรมเสร็จสิ้น)
	if activityComplete then
		activityComplete.OnClientEvent:Connect(function(activityType)
			debugLog("⭐ ได้รับเหตุการณ์ ActivityComplete: " .. activityType)

			-- ถ้าเป็นการเคลื่อนที่ที่เสร็จสิ้น
			if activityType == "movement" or activityType == "turn" then
				-- ตั้งสถานะว่าหยุดเคลื่อนที่แล้ว
				isMoving = false

				-- ตั้งสถานะว่าถึงช่องปลายทางแล้ว
				hasReachedEndTile = true

				-- ตรวจสอบว่ามีช่องเงินที่รอดำเนินการหรือไม่
				checkEndTile()
			end
		end)
	end

	-- เชื่อมต่อกับ TileTriggerEvent สำหรับเอฟเฟกต์ช่องทั่วไป
	tileTriggerEvent.OnClientEvent:Connect(function(playerId, tileId, tileType)
		-- จัดการเฉพาะเหตุการณ์สำหรับผู้เล่นในเครื่อง
		if playerId ~= player.UserId then return end

		debugLog("ได้รับเหตุการณ์ตกช่อง: ช่อง " .. tileId .. " ประเภท " .. tileType .. 
			(isMakingPathChoice and " (กำลังเลือกเส้นทาง)" or " (ช่องปกติ)"))

		lastTileId = tileId
		lastTileType = tileType

		-- ถ้ากำลังเลือกเส้นทาง ให้ข้ามการประมวลผล
		if isMakingPathChoice then
			debugLog("⏩ ข้ามการประมวลผลเนื่องจากกำลังเลือกเส้นทาง")
			return
		end

		-- จัดการประเภทช่องต่างๆ
		if tileType == "money" then
			debugLog("ตกช่องเงิน รอการแสดงผล UI เมื่อถึงช่องปลายทาง")
			createNotification("คุณตกช่องเงิน! เงินจะถูกสุ่มเมื่อถึงช่องปลายทาง", 2, MONEY_COLOR)

			-- กำหนดให้รอการประมวลผล
			pendingMoneyTile = true
		elseif tileType == "shop" then
			debugLog("ตกช่องร้านค้า")
			createNotification("คุณตกช่องร้านค้า", 2, SHOP_COLOR)
		elseif tileType == "battle" then
			debugLog("ตกช่องต่อสู้")
			createNotification("คุณตกช่องต่อสู้! เตรียมตัวให้พร้อม", 2, BATTLE_COLOR)
		elseif tileType == "casino" then
			debugLog("ตกช่องคาสิโน")
			createNotification("คุณตกช่องคาสิโน! อยากลองเสี่ยงโชคไหม?", 2, CASINO_COLOR)
		elseif tileType == "item" then
			debugLog("ตกช่องไอเทม")
			createNotification("คุณตกช่องไอเทม! กำลังสุ่มไอเทม...", 2, ITEM_COLOR)
		end
	end)

	-- ค้นหา DiceRollUI.PathSelectionContainer เพื่อตรวจจับการเลือกเส้นทาง
	task.spawn(function()
		local PlayerGui = player:WaitForChild("PlayerGui")
		local PopupUI = PlayerGui:WaitForChild("PopupUI", 10)
		if PopupUI then
			local DiceRollUI = PopupUI:WaitForChild("DiceRollUI", 10)
			if DiceRollUI then
				local PathSelectionContainer = DiceRollUI:WaitForChild("PathSelectionContainer", 10)
				if PathSelectionContainer then
					-- ติดตามเมื่อ PathSelectionContainer แสดงหรือซ่อน
					PathSelectionContainer:GetPropertyChangedSignal("Visible"):Connect(function()
						isMakingPathChoice = PathSelectionContainer.Visible
						debugLog("📍 การเลือกเส้นทาง: " .. (isMakingPathChoice and "เปิด" or "ปิด"))
					end)
					debugLog("✅ เชื่อมต่อกับ PathSelectionContainer.Visible เรียบร้อย")
				end
			end
		end
	end)

	-- ตรวจจับการเคลื่อนที่จริงๆ ของตัวละคร
	task.spawn(function()
		while true do
			task.wait(MOVEMENT_CHECK_INTERVAL) -- ตรวจสอบทุก x วินาที

			local character = player.Character
			if character and character:FindFirstChild("HumanoidRootPart") and character:FindFirstChild("Humanoid") then
				local humanoid = character:FindFirstChild("Humanoid")

				-- เช็คสถานะการเคลื่อนที่โดยตรง
				if humanoid.MoveDirection.Magnitude > 0 then
					if not isMoving then
						debugLog("🚶 ตรวจพบการเคลื่อนที่ของตัวละคร")
						isMoving = true
						hasReachedEndTile = false
					end
				else
					if isMoving then
						debugLog("🛑 ตรวจพบตัวละครหยุดเคลื่อนที่")
						isMoving = false

						-- รอสักครู่เพื่อให้แน่ใจว่าหยุดจริงๆ
						task.delay(DELAY_BEFORE_UI, function()
							if pendingMoneyTile and not isMoving then
								debugLog("🔄 ตัวละครหยุดเคลื่อนที่และมีช่องเงินรอดำเนินการ ตั้งค่า hasReachedEndTile เป็น true")
								hasReachedEndTile = true
								checkEndTile()
							end
						end)
					end
				end
			end
		end
	end)
end

-- Test functions
local function setupTestFunctions()
	-- สร้างฟังก์ชันทดสอบที่สามารถเรียกได้จาก Command Bar
	_G.TestMoneyUI = function(amount)
		amount = amount or getRandomMoneyAmount()
		debugLog("ทดสอบ UI เงินด้วยจำนวน: " .. amount)
		showMoneyAnimationWithExistingUI(amount)
		return "กำลังทดสอบ UI สุ่มเงินด้วยจำนวน " .. amount .. " เหรียญ"
	end

	-- ทดสอบเล่นเฉพาะอนิเมชันหมุนการ์ด
	_G.TestCardAnimation = function()
		local moneyUI = findMoneyRandomizerUI()
		if moneyUI then
			local mainFrame
			if moneyUI:IsA("Frame") then
				mainFrame = moneyUI
			else
				mainFrame = moneyUI:FindFirstChild("MainFrame")
			end

			if mainFrame then
				moneyUI.Enabled = true
				mainFrame.Visible = true
				playCardRevealAnimation(mainFrame)
				return "กำลังทดสอบอนิเมชันการ์ด"
			end
		end
		return "ไม่พบ UI ที่จะทดสอบอนิเมชันการ์ด"
	end

	-- เพิ่มฟังก์ชันจำลองการตกช่องเงินและการถึงช่องปลายทาง
	_G.TestMoneyTileSequence = function()
		debugLog("ทดสอบลำดับการตกช่องเงินและถึงช่องปลายทาง")

		-- รีเซ็ตสถานะก่อน
		pendingMoneyTile = false
		isMoving = false
		hasReachedEndTile = false
		isProcessingEvent = false

		-- จำลองการตกช่องเงิน
		pendingMoneyTile = true
		createNotification("คุณตกช่องเงิน! เงินจะถูกสุ่มเมื่อถึงช่องปลายทาง", 2, MONEY_COLOR)

		-- จำลองการเคลื่อนที่
		debugLog("จำลองการเริ่มเคลื่อนที่...")
		isMoving = true

		-- รอ 2 วินาทีแล้วจำลองการหยุดเคลื่อนที่และถึงช่องปลายทาง
		task.delay(2, function()
			debugLog("จำลองการหยุดเคลื่อนที่และถึงช่องปลายทาง")
			isMoving = false
			hasReachedEndTile = true

			-- ตรวจสอบช่องปลายทาง
			checkEndTile()
		end)

		return "กำลังทดสอบลำดับการทำงานตั้งแต่ตกช่องเงินจนถึงช่องปลายทาง"
	end
end

-- Main initialization function
local function initialize()
	debugLog("เริ่มต้นระบบ EventTileHandler...")

	-- Initialize remote events
	initRemotes()

	-- Set up event connections
	setupConnections()

	-- Set up test functions
	setupTestFunctions()

	-- ทดสอบหา UI MedievalMoneyRandomizer อัตโนมัติเมื่อโค้ดเริ่มทำงาน
	task.spawn(function()
		task.wait(2) -- รอสักครู่ให้ UI โหลดเสร็จ
		local ui = findMoneyRandomizerUI()
		if ui then
			debugLog("✅ พบ UI MedievalMoneyRandomizer ที่จะใช้: " .. ui:GetFullName())
		else
			debugLog("❌ ไม่พบ UI MedievalMoneyRandomizer ที่จะใช้งาน กรุณาตรวจสอบชื่อ UI")
		end
	end)

	print("[EventTileHandler] เริ่มต้นแล้ว")
	print("================ ระบบช่องพิเศษ (Event Tile) พร้อมใช้งานแล้ว ================")
	print("คุณสามารถทดสอบ UI สุ่มเงินได้โดยพิมพ์:")
	print("- _G.TestMoneyUI() - ทดสอบการสุ่มเงินกับ UI ที่มีอยู่แล้ว")
	print("- _G.TestCardAnimation() - ทดสอบเฉพาะอนิเมชันหมุนไพ่")
	print("- _G.TestMoneyTileSequence() - จำลองลำดับเหตุการณ์ตกช่องเงินและถึงช่องปลายทาง")
end

-- Start the system
initialize()
