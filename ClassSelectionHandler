-- ClassSelectionHandler.lua
-- Manages character class selection screen
-- Version: 3.1.0 (Optimized)

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

-- Get current player
local player = Players.LocalPlayer
if not player then
	Players:GetPropertyChangedSignal("LocalPlayer"):Wait()
	player = Players.LocalPlayer
end

-- UI references
local PlayerGui, ClassSelection, Background, TitleText, ClassesContainer
local ConfirmButton, TimerFrame, TimerText, PlayersSelectionStatus
local WarriorClass, MageClass, ThiefClass

-- RemoteEvents references
local remotes = {}

-- Selection state
local selectionState = {
	selectedClass = nil,
	isConfirmed = false,
	playerSelections = {},
	playerFrames = {},
	timerValue = 30,
	isTimerActive = false
}

-- Track connections
local connections = {}

-- Standard UI colors
local COLORS = {
	DEFAULT_FRAME = Color3.fromRGB(50, 50, 70),
	SELECTED_FRAME = Color3.fromRGB(60, 90, 140),
	HOVER_FRAME = Color3.fromRGB(60, 70, 100),
	DEFAULT_STROKE = Color3.fromRGB(100, 100, 150),
	SELECTED_STROKE = Color3.fromRGB(100, 200, 255),
	CONFIRM_ENABLED = Color3.fromRGB(40, 140, 60),
	CONFIRM_DISABLED = Color3.fromRGB(60, 60, 80),
	TIMER_NORMAL = Color3.fromRGB(255, 255, 255),
	TIMER_WARNING = Color3.fromRGB(255, 150, 50),
	TIMER_CRITICAL = Color3.fromRGB(255, 50, 50)
}

-- Tween settings
local tweenInfo = {
	fast = TweenInfo.new(0.2, Enum.EasingStyle.Quad),
	normal = TweenInfo.new(0.3, Enum.EasingStyle.Quad),
	slow = TweenInfo.new(0.5, Enum.EasingStyle.Quad),
	bounce = TweenInfo.new(0.4, Enum.EasingStyle.Bounce)
}

-- Helper function for creating tweens
local function createTween(object, properties, duration, style)
	local info = TweenInfo.new(
		duration or 0.3, 
		style or Enum.EasingStyle.Quad, 
		Enum.EasingDirection.Out
	)
	return TweenService:Create(object, info, properties)
end

-- Clean up connections
local function cleanupConnections()
	for _, connection in ipairs(connections) do
		if typeof(connection) == "RBXScriptConnection" and connection.Connected then
			connection:Disconnect()
		end
	end
	connections = {}
end

-- Apply effects to UI elements
local function applyUIEffects()
	-- Add hover effects to class frames
	for _, classFrame in pairs({WarriorClass, MageClass, ThiefClass}) do
		if not classFrame then continue end

		classFrame.BackgroundTransparency = 0.1

		-- Add UIStroke if missing
		if not classFrame:FindFirstChild("UIStroke") then
			local stroke = Instance.new("UIStroke")
			stroke.Color = COLORS.DEFAULT_STROKE
			stroke.Thickness = 2
			stroke.Parent = classFrame
		end

		-- Add hover effects
		local mouseEnter = classFrame.MouseEnter:Connect(function()
			if not selectionState.selectedClass or 
				classFrame.Name:sub(1, -6) ~= selectionState.selectedClass then
				createTween(classFrame, {BackgroundColor3 = COLORS.HOVER_FRAME}, 0.2):Play()
			end
		end)

		local mouseLeave = classFrame.MouseLeave:Connect(function()
			if not selectionState.selectedClass or 
				classFrame.Name:sub(1, -6) ~= selectionState.selectedClass then
				createTween(classFrame, {BackgroundColor3 = COLORS.DEFAULT_FRAME}, 0.2):Play()
			end
		end)

		table.insert(connections, mouseEnter)
		table.insert(connections, mouseLeave)
	end

	-- Add confirm button effects
	if ConfirmButton then
		-- Add UIStroke if missing
		if not ConfirmButton:FindFirstChild("UIStroke") then
			local stroke = Instance.new("UIStroke")
			stroke.Color = COLORS.DEFAULT_STROKE
			stroke.Thickness = 2
			stroke.Parent = ConfirmButton
		end

		-- Add hover effects
		local mouseEnter = ConfirmButton.MouseEnter:Connect(function()
			if selectionState.selectedClass and not selectionState.isConfirmed then
				createTween(
					ConfirmButton, 
					{Size = UDim2.new(ConfirmButton.Size.X.Scale * 1.05, 0, ConfirmButton.Size.Y.Scale * 1.05, 0)},
					0.2
				):Play()
			end
		end)

		local mouseLeave = ConfirmButton.MouseLeave:Connect(function()
			if selectionState.selectedClass and not selectionState.isConfirmed then
				createTween(
					ConfirmButton, 
					{Size = UDim2.new(ConfirmButton.Size.X.Scale / 1.05, 0, ConfirmButton.Size.Y.Scale / 1.05, 0)},
					0.2
				):Play()
			end
		end)

		table.insert(connections, mouseEnter)
		table.insert(connections, mouseLeave)
	end
	end

	-- Initialize UI references
local function initializeUI()
	-- Get PlayerGui and ClassSelection
	PlayerGui = player:WaitForChild("PlayerGui", 10)
	if not PlayerGui then return false end

	ClassSelection = PlayerGui:WaitForChild("ClassSelection", 5)
	if not ClassSelection then return false end

	-- Get main UI components
	Background = ClassSelection:WaitForChild("Background", 3)
	if not Background then return false end

	TitleText = Background:WaitForChild("TitleText", 2)
	ClassesContainer = Background:WaitForChild("ClassesContainer", 2)
	ConfirmButton = Background:WaitForChild("ConfirmButton", 2)
	TimerFrame = Background:WaitForChild("TimerFrame", 2)

	if TimerFrame then TimerText = TimerFrame:WaitForChild("TimerText", 1) end
	PlayersSelectionStatus = Background:WaitForChild("PlayersSelectionStatus", 2)

	-- Validate required components
	if not TitleText or not ClassesContainer or not ConfirmButton or 
		not TimerFrame or not TimerText or not PlayersSelectionStatus then
		return false
	end

	-- Get class frames
	WarriorClass = ClassesContainer:FindFirstChild("WarriorClass")
	MageClass = ClassesContainer:FindFirstChild("MageClass")
	ThiefClass = ClassesContainer:FindFirstChild("ThiefClass")

	if not WarriorClass or not MageClass or not ThiefClass then
		return false
	end

	-- Set initial UI state
	ClassSelection.Enabled = true
	TimerText.Text = "Time remaining: " .. selectionState.timerValue .. " seconds"

	return true
end

-- Connect to RemoteEvents
local function connectRemoteEvents()
	-- Get Remotes folders
	local remotesFolder = ReplicatedStorage:WaitForChild("Remotes", 10)
	if not remotesFolder then return false end

	local uiRemotes = remotesFolder:WaitForChild("UIRemotes", 5)

	-- Get RemoteEvents
	remotes.playerSelectedClass = uiRemotes:WaitForChild("PlayerSelectedClass", 3)
	remotes.updateClassSelection = uiRemotes:WaitForChild("UpdateClassSelection", 3)
	remotes.updateClassSelectionTimer = uiRemotes:WaitForChild("UpdateClassSelectionTimer", 3)
	remotes.notifyRandomClass = uiRemotes:WaitForChild("NotifyRandomClass", 3)
	remotes.showMainGameUI = uiRemotes:WaitForChild("ShowMainGameUI", 3)

	-- Validate all remotes
	for name, remote in pairs(remotes) do
		if not remote then return false end
	end

	return true
end

-- Update class display
local function updateClassVisuals()
	-- Reset all class frames
	for _, classFrame in pairs({WarriorClass, MageClass, ThiefClass}) do
		if classFrame then
			createTween(classFrame, {
				BackgroundColor3 = COLORS.DEFAULT_FRAME,
				BackgroundTransparency = 0.1
			}):Play()

			local stroke = classFrame:FindFirstChild("UIStroke")
			if stroke then
				stroke.Color = COLORS.DEFAULT_STROKE
				stroke.Thickness = 2
			end
		end
	end

	-- Highlight selected class
	if selectionState.selectedClass then
		local selectedFrame
		if selectionState.selectedClass == "Warrior" then selectedFrame = WarriorClass
		elseif selectionState.selectedClass == "Mage" then selectedFrame = MageClass
		elseif selectionState.selectedClass == "Thief" then selectedFrame = ThiefClass
		end

		if selectedFrame then
			createTween(selectedFrame, {
				BackgroundColor3 = COLORS.SELECTED_FRAME,
				BackgroundTransparency = 0
			}):Play()

			local stroke = selectedFrame:FindFirstChild("UIStroke")
			if stroke then
				stroke.Color = COLORS.SELECTED_STROKE
				stroke.Thickness = 3
			end
		end
	end

	-- Update confirm button state
	if ConfirmButton then
		if selectionState.selectedClass and not selectionState.isConfirmed then
			-- Active state
			ConfirmButton.BackgroundColor3 = COLORS.CONFIRM_ENABLED
			ConfirmButton.Active = true
			ConfirmButton.AutoButtonColor = true

			local stroke = ConfirmButton:FindFirstChild("UIStroke")
			if stroke then
				stroke.Color = Color3.fromRGB(100, 255, 100)
				stroke.Thickness = 2
			end

			local confirmText = ConfirmButton:FindFirstChild("ConfirmText")
			if confirmText then
				confirmText.TextColor3 = Color3.fromRGB(255, 255, 255)
			end
		else
			-- Inactive state
			ConfirmButton.BackgroundColor3 = COLORS.CONFIRM_DISABLED

			if selectionState.isConfirmed then
				ConfirmButton.Active = false
				ConfirmButton.AutoButtonColor = false

				local confirmText = ConfirmButton:FindFirstChild("ConfirmText")
				if confirmText then
					confirmText.Text = "Waiting for others..."
					confirmText.TextColor3 = Color3.fromRGB(200, 200, 200)
				end
			else
				ConfirmButton.Active = false

				local stroke = ConfirmButton:FindFirstChild("UIStroke")
				if stroke then
					stroke.Color = Color3.fromRGB(150, 150, 150)
					stroke.Thickness = 1
				end

				local confirmText = ConfirmButton:FindFirstChild("ConfirmText")
				if confirmText then
					confirmText.TextColor3 = Color3.fromRGB(200, 200, 200)
				end
			end
		end
	end
end

-- Select class function
local function selectClass(className)
	-- Don't allow selection after confirmation
	if selectionState.isConfirmed then return end

	-- Validate class name
	if className ~= "Warrior" and className ~= "Mage" and className ~= "Thief" then
		return
	end

	-- Set selected class
	selectionState.selectedClass = className

	-- Update display
	updateClassVisuals()

	-- Show selection effect
	local selectedFrame
	if className == "Warrior" then selectedFrame = WarriorClass
	elseif className == "Mage" then selectedFrame = MageClass
	elseif className == "Thief" then selectedFrame = ThiefClass
	end

	if selectedFrame then
		-- Pulse animation
		createTween(
			selectedFrame,
			{Size = UDim2.new(selectedFrame.Size.X.Scale * 1.05, 0, selectedFrame.Size.Y.Scale * 1.05, 0)},
			0.4,
			Enum.EasingStyle.Bounce
		):Play()

		wait(0.4)

		if selectionState.selectedClass == className then
			createTween(
				selectedFrame,
				{Size = UDim2.new(selectedFrame.Size.X.Scale / 1.05, 0, selectedFrame.Size.Y.Scale / 1.05, 0)}
			):Play()
		end
	end
end

-- Update timer display
local function updateTimer(timeLeft)
	-- Update timer value
	selectionState.timerValue = timeLeft

	-- Update display
	if TimerText then
		TimerText.Text = "Time remaining: " .. timeLeft .. " seconds"

		-- Change color based on time
		if timeLeft <= 5 then
			TimerText.TextColor3 = COLORS.TIMER_CRITICAL

			-- Flash effect
			local flashTween = createTween(
				TimerFrame,
				{BackgroundColor3 = Color3.fromRGB(200, 50, 50)},
				0.3
			)
			flashTween.Completed:Connect(function()
				createTween(
					TimerFrame,
					{BackgroundColor3 = TimerFrame.BackgroundColor3},
					0.3
				):Play()
			end)
			flashTween:Play()

		elseif timeLeft <= 10 then
			TimerText.TextColor3 = COLORS.TIMER_WARNING
		else
			TimerText.TextColor3 = COLORS.TIMER_NORMAL
		end
	end
end

-- Update player selection status
local function updatePlayerSelectionStatus(userId, className)
	-- Store player selection
	selectionState.playerSelections[userId] = className

	-- Find or create player status frame
	if not selectionState.playerFrames[userId] then
		-- Look for template
		local template = PlayersSelectionStatus:FindFirstChild("PlayerStatus")

		if template then
			-- Create new status display
			local newStatus = template:Clone()
			newStatus.Visible = true
			newStatus.Name = "PlayerStatus_" .. userId

			-- Find player name
			local playerName = "Player"
			for _, p in pairs(Players:GetPlayers()) do
				if p.UserId == userId then
					playerName = p.Name
					break
				end
			end

			-- Set initial text
			newStatus.Text = playerName .. ": Selecting..."

			-- Set position
			local playerCount = 0
			for _ in pairs(selectionState.playerFrames) do
				playerCount = playerCount + 1
			end
			newStatus.LayoutOrder = playerCount + 1

			-- Store reference
			selectionState.playerFrames[userId] = newStatus
			newStatus.Parent = PlayersSelectionStatus
		end
	end

	-- Update display
	local statusFrame = selectionState.playerFrames[userId]
	if statusFrame and className then
		-- Find player name
		local playerName = "Player"
		for _, p in pairs(Players:GetPlayers()) do
			if p.UserId == userId then
				playerName = p.Name
				break
			end
		end

		-- Update text and color
		statusFrame.Text = playerName .. ": " .. className
		statusFrame.TextColor3 = Color3.fromRGB(100, 255, 100)

		-- Pulse animation
		createTween(statusFrame, {TextSize = statusFrame.TextSize + 2}, 0.3):Play()
		wait(0.3)
		createTween(statusFrame, {TextSize = statusFrame.TextSize - 2}, 0.3):Play()
	end

	-- Update count
	local selectedCount = 0
	local totalPlayers = #Players:GetPlayers()

	for _, selection in pairs(selectionState.playerSelections) do
		if selection then selectedCount = selectedCount + 1 end
	end

	-- Update title
	if TitleText then
		TitleText.Text = "Select Your Character Class (" .. selectedCount .. "/" .. totalPlayers .. ")"
	end
end

-- Confirm selection function
local function confirmSelection()
	-- Check if class is selected and not already confirmed
	if not selectionState.selectedClass or selectionState.isConfirmed then return end

	-- Set confirmed state
	selectionState.isConfirmed = true

	-- Disable class selection
	for _, classFrame in pairs({WarriorClass, MageClass, ThiefClass}) do
		if classFrame then classFrame.Active = false end
	end

	-- Update button
	if ConfirmButton then
		ConfirmButton.Active = false
		ConfirmButton.AutoButtonColor = false

		createTween(ConfirmButton, {
			BackgroundColor3 = Color3.fromRGB(30, 100, 30),
			BackgroundTransparency = 0.3
		}):Play()

		local confirmText = ConfirmButton:FindFirstChild("ConfirmText")
		if confirmText then
			confirmText.Text = "Waiting for others..."
		end
	end

	-- Send to server
	if remotes.playerSelectedClass then
		remotes.playerSelectedClass:FireServer(selectionState.selectedClass)
	end

	-- Update own selection status
	updatePlayerSelectionStatus(player.UserId, selectionState.selectedClass)
end

-- Handle random class assignment
local function handleRandomClassAssignment(className)
	-- Select the random class
	selectClass(className)

	-- Create notification
	local notification = Instance.new("Frame")
	notification.Name = "RandomClassNotification"
	notification.Size = UDim2.new(0.6, 0, 0.15, 0)
	notification.Position = UDim2.new(0.2, 0, -0.2, 0)
	notification.BackgroundColor3 = Color3.fromRGB(200, 80, 80)
	notification.BackgroundTransparency = 0.2
	notification.BorderSizePixel = 0
	notification.ZIndex = 10

	-- Add design elements
	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, 8)
	corner.Parent = notification

	local stroke = Instance.new("UIStroke")
	stroke.Color = Color3.fromRGB(255, 150, 150)
	stroke.Thickness = 3
	stroke.Parent = notification

	-- Add text
	local notificationText = Instance.new("TextLabel")
	notificationText.Size = UDim2.new(1, 0, 1, 0)
	notificationText.BackgroundTransparency = 1
	notificationText.Text = "Time's up! System randomly selected " .. className .. " for you"
	notificationText.TextColor3 = Color3.fromRGB(255, 255, 255)
	notificationText.TextSize = 20
	notificationText.Font = Enum.Font.GothamBold
	notificationText.TextWrapped = true
	notificationText.ZIndex = 11
	notificationText.Parent = notification

	-- Show notification
	notification.Parent = Background

	-- Slide in
	createTween(notification, {Position = UDim2.new(0.2, 0, 0.1, 0)}, 0.5):Play()

	-- Confirm selection
	wait(0.8)
	confirmSelection()

	-- Remove notification
	wait(3)
	createTween(notification, {
		Position = UDim2.new(0.2, 0, -0.2, 0),
		BackgroundTransparency = 1
	}, 0.5):Play()

	wait(0.5)
	notification:Destroy()
end

-- Transition to main game
local function transitionToMainGame()
	-- Fade out effect
	local fadeOutTween = createTween(Background, {BackgroundTransparency = 1}, 0.5)

	-- Fade out all elements
	local fadeElements = {}
	for _, element in pairs(Background:GetDescendants()) do
		if element:IsA("Frame") or element:IsA("ImageLabel") or element:IsA("ImageButton") then
			createTween(element, {BackgroundTransparency = 1}, 0.5):Play()
		elseif element:IsA("TextLabel") or element:IsA("TextButton") then
			createTween(element, {
				BackgroundTransparency = 1,
				TextTransparency = 1
			}, 0.5):Play()
		end
	end

	-- Play fade out
	fadeOutTween:Play()

	-- Handle transition
	fadeOutTween.Completed:Connect(function()
		-- Disable class selection
		ClassSelection.Enabled = false

		-- Find and show main game UI
		local MainGameUI = PlayerGui:WaitForChild("MainGameUI", 5)
		if MainGameUI then
			MainGameUI.Enabled = true
		end

		-- Clean up
		cleanupConnections()
	end)
end

-- Setup button connections
local function setupButtonConnections()
	-- Clear previous connections
	cleanupConnections()

	-- Connect class buttons
	local function connectClassButton(classButton, className)
		if not classButton then return end

		local connection = classButton.InputBegan:Connect(function(input)
			if input.UserInputType == Enum.UserInputType.MouseButton1 or 
				input.UserInputType == Enum.UserInputType.Touch then
				selectClass(className)
			end
		end)

		table.insert(connections, connection)
	end

	connectClassButton(WarriorClass, "Warrior")
	connectClassButton(MageClass, "Mage")
	connectClassButton(ThiefClass, "Thief")

	-- Connect confirm button
	if ConfirmButton then
		local connection = ConfirmButton.InputBegan:Connect(function(input)
			if input.UserInputType == Enum.UserInputType.MouseButton1 or 
				input.UserInputType == Enum.UserInputType.Touch then
				confirmSelection()
			end
		end)

		table.insert(connections, connection)
	end

	-- Connect Enter key for confirmation
	local connection = UserInputService.InputBegan:Connect(function(input)
		if input.KeyCode == Enum.KeyCode.Return and 
			selectionState.selectedClass and not selectionState.isConfirmed then
			confirmSelection()
		end
	end)

	table.insert(connections, connection)
end

-- Setup remote event connections
local function setupRemoteConnections()
	-- Update class selection status
	if remotes.updateClassSelection then
		local connection = remotes.updateClassSelection.OnClientEvent:Connect(function(userId, className)
			updatePlayerSelectionStatus(userId, className)
		end)

		table.insert(connections, connection)
	end

	-- Update timer
	if remotes.updateClassSelectionTimer then
		local connection = remotes.updateClassSelectionTimer.OnClientEvent:Connect(function(timeLeft)
			updateTimer(timeLeft)
		end)

		table.insert(connections, connection)
	end

	-- Handle random class assignment
	if remotes.notifyRandomClass then
		local connection = remotes.notifyRandomClass.OnClientEvent:Connect(function(className)
			handleRandomClassAssignment(className)
		end)

		table.insert(connections, connection)
	end

	-- Transition to main game
	if remotes.showMainGameUI then
		local connection = remotes.showMainGameUI.OnClientEvent:Connect(function()
			transitionToMainGame()
		end)

		table.insert(connections, connection)
	end

	-- Player count tracking
	local connection = Players.PlayerAdded:Connect(function()
		wait()

		-- Update player count
		local selectedCount = 0
		for _, selection in pairs(selectionState.playerSelections) do
			if selection then selectedCount = selectedCount + 1 end
		end

		if TitleText then
			TitleText.Text = "Select Your Character Class (" .. selectedCount .. "/" .. #Players:GetPlayers() .. ")"
		end
	end)

	table.insert(connections, connection)

	connection = Players.PlayerRemoving:Connect(function(plr)
		wait()

		-- Remove data for player
		if selectionState.playerSelections[plr.UserId] then
			selectionState.playerSelections[plr.UserId] = nil
		end

		if selectionState.playerFrames[plr.UserId] then
			selectionState.playerFrames[plr.UserId]:Destroy()
			selectionState.playerFrames[plr.UserId] = nil
		end

		-- Update player count
		local selectedCount = 0
		for _, selection in pairs(selectionState.playerSelections) do
			if selection then selectedCount = selectedCount + 1 end
		end

		if TitleText then
			TitleText.Text = "Select Your Character Class (" .. selectedCount .. "/" .. #Players:GetPlayers() .. ")"
		end
	end)

	table.insert(connections, connection)
end

-- Initialization function
local function initialize()
	-- Setup UI
	if not initializeUI() then
		return
	end

	-- Connect to RemoteEvents
	if not connectRemoteEvents() then
		return
	end

	-- Apply UI effects
	applyUIEffects()

	-- Setup button connections
	setupButtonConnections()

	-- Setup remote connections
	setupRemoteConnections()

	-- Update initial display
	updateClassVisuals()

	-- Update initial player count
	if TitleText then
		TitleText.Text = "Select Your Character Class (0/" .. #Players:GetPlayers() .. ")"
	end

	-- Show current player status
	updatePlayerSelectionStatus(player.UserId)
end

-- Setup cleanup when player leaves
Players.PlayerRemoving:Connect(function(plr)
	if plr == player then
		cleanupConnections()
	end
end)

-- Start system
initialize()
